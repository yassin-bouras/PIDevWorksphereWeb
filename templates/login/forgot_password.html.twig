<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0" />
  <title>Forgot Password</title>

  <link rel="stylesheet" href="{{ asset('back/css/bootstrap.min.css') }}" />
  <link rel="stylesheet" href="{{ asset('back/plugins/fontawesome/css/fontawesome.min.css') }}" />
  <link rel="stylesheet" href="{{ asset('back/plugins/fontawesome/css/all.min.css') }}" />
  <link rel="stylesheet" href="{{ asset('back/css/style.css') }}" />

  <style>
    .hidden { display: none; }
    .form-group { margin-bottom: 15px; }
  </style>
</head>
<body>
  <div class="main-wrapper login-body">
    <div class="login-wrapper">
      <div class="container">
        <div class="loginbox">
          <div class="login-right">
            <div class="login-right-wrap">
              <h1>Réinitialiser le mot de passe</h1>
              <p>Entrez votre email pour recevoir un code de vérification.</p>

              <div id="email-section">
                <div class="form-group">
                  <input type="email" id="email" class="form-control" placeholder="Votre email" required />
                </div>
                <button class="btn btn-primary btn-block" onclick="sendVerificationCode()">Envoyer le Code</button>
              </div>

              <div id="code-section" class="hidden">
                <hr />
                <p>Un code a été envoyé à votre email. Veuillez le saisir :</p>
                <div class="form-group">
                  <input type="text" id="code" class="form-control" placeholder="Code de vérification" />
                </div>
                <button class="btn btn-success btn-block" onclick="verifyCode()">Vérifier</button>
              </div>

              <div id="reset-section" class="hidden">
                <hr />
                <p>Choisissez un nouveau mot de passe :</p>
                <div class="form-group">
                  <input type="password" id="newPassword" class="form-control" placeholder="Nouveau mot de passe" />
                </div>
                <div class="form-group">
                  <input type="password" id="repeatPassword" class="form-control" placeholder="Confirmez le mot de passe" />
                </div>
                <button class="btn btn-warning btn-block" onclick="resetPassword()">Réinitialiser</button>
              </div>

              <div class="text-center mt-3">
                <a href="{{ path('app_login') }}">Retour à la Connexion</a>
              </div>

              <div id="message" class="mt-3 text-center text-danger"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {# NO jQuery needed — using Fetch API #}
  <script>
    let generatedCode = '';
    let userEmail = '';

    function showMessage(msg, type = 'danger') {
      const message = document.getElementById('message');
      message.textContent = msg;
      message.className = `mt-3 text-center text-${type}`;
    }

    function sendVerificationCode() {
      const emailInput = document.getElementById('email');
      const email = emailInput.value.trim();
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      if (!emailRegex.test(email)) {
        showMessage('Adresse email invalide.');
        return;
      }

      generatedCode = Math.floor(100000 + Math.random() * 900000).toString();
      userEmail = email;

      fetch('{{ path("api_send_email") }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          recipient: email,
          subject: "Code de vérification",
          content: `Voici votre code de vérification: ${generatedCode}`
        }),
      })
      .then(res => {
        if (!res.ok) throw new Error('Erreur lors de l\'envoi du code.');
        showMessage('Le code a été envoyé à votre email.', 'success');
        document.getElementById('code-section').classList.remove('hidden');
      })
      .catch(() => showMessage("Erreur lors de l'envoi du code."));
    }

    function verifyCode() {
      const inputCode = document.getElementById('code').value.trim();
      if (inputCode === generatedCode) {
        document.getElementById('code-section').classList.add('hidden');
        document.getElementById('reset-section').classList.remove('hidden');
        showMessage('');
      } else {
        showMessage('Code incorrect. Réessayez.');
      }
    }

    function resetPassword() {
      const pass1 = document.getElementById('newPassword').value.trim();
      const pass2 = document.getElementById('repeatPassword').value.trim();
      const passwordRegex = /^(?=.*\d).{8,}$/;

      if (!passwordRegex.test(pass1)) {
        showMessage('Le mot de passe doit contenir au moins 8 caractères et un chiffre.');
        return;
      }

      if (pass1 !== pass2) {
        showMessage('Les mots de passe ne correspondent pas.');
        return;
      }

      fetch('{{ path("api_reset_password") }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          email: userEmail,
          newPassword: pass1
        }),
      })
      .then(res => {
        if (!res.ok) {
          return res.json().then(data => {
            throw new Error(data.error || 'Erreur lors de la réinitialisation.');
          });
        }
        showMessage('Mot de passe réinitialisé avec succès!', 'success');
        document.getElementById('reset-section').classList.add('hidden');
      })
      .catch(err => showMessage(err.message));
    }
  </script>
</body>
</html>
